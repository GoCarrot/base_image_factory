[Unit]
Description=TD Agent Bit
Requires=network.target
After=network.target

[Service]
ReadOnlyPaths=/
ProtectSystem=strict
StateDirectory=td-agent-bit
CacheDirectory=td-agent-bit
LogsDirectory=td-agent-bit
ConfigurationDirectory=td-agent-bit

NoNewPrivileges=yes
PrivateTmp=yes
PrivateUsers=yes
ProtectClock=yes
PrivateDevices=yes
ProtectKernelTunables=yes
ProtectKernelModules=yes
ProtectControlGroups=yes
RestrictSUIDSGID=yes
RestrictRealtime=yes
LockPersonality=yes
RemoveIPC=yes
UMask=0077

SystemCallArchitectures=native
SystemCallFilter=~@clock @cpu-emulation @debug @module @mount @obsolete @privileged @raw-io @reboot @resources @swap

CapabilityBoundingSet=
RestrictAddressFamilies=~AF_NETLINK AF_PACKET
RestrictNamespaces=yes

Environment="TEAK_SERVICE=unknown"

User={{ fluentbit_user.name }}
Type=simple
# I would prefer to get the hostname from systemd using %H. However, with
# cloud-init we will dynamically change our hostname during boot, and
# cloud-init doesn't provide a hook point that would let us reload systemd
# config _after_ updating hostname but _before_ completing the cloud-init.target
# So, we run in a subshell that grabs the hostname at the time of ExecStart
# to provide it to td-agent-bit.
ExecStart=/bin/sh -c "HOSTNAME=`hostname` /opt/td-agent-bit/bin/td-agent-bit -c {{ fluentbit_config.dest }}"
Restart=always

[Install]
WantedBy=multi-user.target
